<div class="section">
    <div class="row">
        <div class="col">
            <mat-form-field>
                <mat-label>Monster Name</mat-label>
                <input
                    matInput
                    type="text"
                    [ngModel]="monsterService.name()"
                    (ngModelChange)="monsterService.name.set($event)"
                />
            </mat-form-field>
        </div>
        <div class="col">
            <mat-form-field>
                <mat-label>Pronoun</mat-label>
                <mat-select
                    [value]="monsterService.pronoun()"
                    (selectionChange)="monsterService.pronoun.set($event.value)"
                >
                    <!-- versionChange() -->
                    @for (cl of monsterService.pronouns; track cl; let i = $index) {
                        <mat-option [value]="cl">{{ cl }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>
        </div>
    </div>
</div>

<div class="section">
    <div class="row">
        <div class="col">
            <h3>Attack Markup</h3>
            <i
                ><b>{{ attackName }}.</b> {{ attackProximity }}
                {{ attackForm.value.type }} Attack: </i
            >[rollable]+{{ attackForm.value.toHit }};&lcub;"diceNotation":"1d20+{{
                attackForm.value.toHit
            }}","rollType":"to hit","rollAction":"{{ attackName }}"&rcub;[/rollable] to hit,
            {{ reachText }}, {{ attackForm.value.targets }}.
            <i>Hit:</i>
            {{ damageMessages }}{{ saveMessages }}.
        </div>
    </div>
</div>

<form [formGroup]="attackForm">
    <div class="section">
        <h3>Attack</h3>
        <div class="row row-cols-auto">
            <div class="col">
                <mat-form-field>
                    <mat-label>Attack Name</mat-label>
                    <input matInput type="text" formControlName="name" />
                </mat-form-field>
            </div>
            <div class="col">
                <mat-form-field>
                    <mat-label>Attack Proximity</mat-label>
                    <mat-select formControlName="proximity">
                        <mat-option value="Melee">Melee</mat-option>
                        <mat-option value="Ranged">Ranged</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="col">
                <mat-form-field>
                    <mat-label>Attack Type</mat-label>
                    <mat-select formControlName="type">
                        <mat-option value="Weapon">Weapon</mat-option>
                        <mat-option value="Spell">Spell</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="col">
                <mat-form-field>
                    <mat-label>To Hit</mat-label>
                    <input matInput formControlName="toHit" type="number" />
                </mat-form-field>
            </div>
            <div class="col">
                @if (attackProximity === 'Melee') {
                    <mat-form-field>
                        <mat-label>Reach</mat-label>
                        <input matInput formControlName="reach" type="number" />
                    </mat-form-field>
                } @else {
                    <mat-form-field>
                        <mat-label>Range</mat-label>
                        <input matInput formControlName="range" type="number" />
                    </mat-form-field>
                    /
                    <mat-form-field>
                        <mat-label>Range Disadvantage</mat-label>
                        <input matInput formControlName="rangeDisadvantage" type="number" />
                    </mat-form-field>
                }
            </div>
            <div class="col">
                <mat-form-field>
                    <mat-label>Targets</mat-label>
                    <input matInput formControlName="targets" type="text" />
                </mat-form-field>
            </div>
        </div>
    </div>
    <div class="section">
        <h3>
            Damage ({{ damagePerAttack }} per attack)
            <button matButton="outlined" (click)="addAttack()">Add</button>
        </h3>
        <ng-container formArrayName="damages">
            @for (damageGroup of damages.controls; track damageGroup.value.id; let i = $index) {
                <ng-container [formGroupName]="i">
                    <div class="row row-cols-auto">
                        <div class="col">
                            <mat-form-field>
                                <mat-label>Amount</mat-label>
                                <input matInput formControlName="amount" type="number" />
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <mat-form-field>
                                <mat-label>Die Sides</mat-label>
                                <mat-select formControlName="sides">
                                    <mat-option [value]="3">d3</mat-option>
                                    <mat-option [value]="4">d4</mat-option>
                                    <mat-option [value]="6">d6</mat-option>
                                    <mat-option [value]="8">d8</mat-option>
                                    <mat-option [value]="10">d10</mat-option>
                                    <mat-option [value]="12">d12</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <mat-form-field>
                                <mat-label>Damage Type</mat-label>
                                <input matInput formControlName="type" type="text" />
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <mat-form-field>
                                <mat-label>Damage Bonus</mat-label>
                                <input matInput formControlName="bonus" type="number" />
                            </mat-form-field>
                        </div>
                        <div class="col">
                            <button matIconButton (click)="clearDamage(i)">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="markup">
                                {{
                                    getDamageMarkup(
                                        damages.controls[i].value.amount,
                                        damages.controls[i].value.sides,
                                        damages.controls[i].value.bonus,
                                        damages.controls[i].value.type
                                    )
                                }}
                            </div>
                        </div>
                    </div>
                </ng-container>
            }
        </ng-container>
    </div>
    <div class="section">
        <h3>Saves <button matButton="outlined" (click)="addSave()">Add</button></h3>

        <table>
            <thead>
                <tr>
                    <th scope="col">DC</th>
                    <th scope="col">Ability</th>
                    <th scope="col">Effect</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <ng-container formArrayName="saves">
                    @for (
                        saveGroup of saves.controls;
                        track saveGroup.get('id')?.value;
                        let i = $index
                    ) {
                        <tr [formGroupName]="i">
                            <td>
                                <mat-form-field>
                                    <mat-label>DC</mat-label>
                                    <input matInput formControlName="dc" type="number" />
                                </mat-form-field>
                            </td>
                            <td>
                                <mat-form-field>
                                    <mat-label>Abilty</mat-label>
                                    <mat-select formControlName="ability">
                                        <mat-option value="Strength">Strength</mat-option>
                                        <mat-option value="Dexterity">Dexterity</mat-option>
                                        <mat-option value="Constitution">Constitution</mat-option>
                                        <mat-option value="Intelligence">Intelligence</mat-option>
                                        <mat-option value="Wisdom">Wisdom</mat-option>
                                        <mat-option value="Charisma">Charisma</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </td>
                            <td>
                                <mat-form-field>
                                    <mat-label>Effect</mat-label>
                                    <textarea
                                        matInput
                                        formControlName="effect"
                                        rows="5"
                                        cols="53"
                                    ></textarea>
                                </mat-form-field>
                            </td>
                            <td>
                                <button matIconButton (click)="clearSave(i)">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </td>
                        </tr>
                    }
                </ng-container>
            </tbody>
        </table>
    </div>
</form>

<div class="section">
    <h3>Markup List</h3>
    <form [formGroup]="markupForm">
        <div class="row">
            <div class="col col-lg-8 col-md-8">
                <mat-form-field style="width: 100%">
                    <mat-label>Markup Type</mat-label>
                    <mat-select formControlName="type">
                        <mat-option value="action"
                            >action - an action taken in combat - e.g. dodge, search and
                            ready</mat-option
                        >
                        <mat-option value="condition"
                            >condition - a condition afflicted upon a creature - e.g. restrained,
                            poisoned and prone</mat-option
                        >
                        <mat-option value="item"
                            >item - a mundane item - e.g. torch, trident and backpack</mat-option
                        >
                        <mat-option value="magicItem"
                            >magicItem - a magical item - e.g. Bag of Holding, Dust of Disappearance
                            and Demon Armor</mat-option
                        >
                        <mat-option value="monster"
                            >monster - a creature you can encounter - e.g. Banshee, Bandit and
                            Unicorn</mat-option
                        >
                        <mat-option value="sense"
                            >sense - a type of extra sense, whether magical or natural - e.g.
                            darkvision, tremorsense and truesight</mat-option
                        >
                        <mat-option value="skill"
                            >skill - this is used for professions - e.g. Persuasion,
                            Stealth</mat-option
                        >
                        <mat-option value="spell"
                            >spell - a magical spell - e.g. Mage Hand, Magic Missile and
                            Abi-Dalzim's Horrid Wilting</mat-option
                        >
                        <mat-option value="wprop"
                            >wprop - a property of a weapon - e.g. finesse, versatile and
                            heavy</mat-option
                        > <mat-option value="rules"
                            >rules - Advantage, etc</mat-option
                        >
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="col">
                <mat-form-field style="width: 100%">
                    <textarea
                        matInput
                        formControlName="list"
                        rows="5"
                        cols="53"
                        placeholder="comma, separated, list"
                    ></textarea>
                </mat-form-field>
            </div>
        </div>
        <div class="row">
            <div class="col markup">{{ markupText }}</div>
        </div>
    </form>
</div>

<div class="section">
    <app-spells />
</div>

<div class="section">
    <h3>Common Traits</h3>
    <p>
        <b><i>Evasion.</i></b> If {{ monsterService.name() }} is subjected to an effect that allows
        {{ monsterService.objectPronoun() }} to make a Dexterity saving throw to take only half
        damage, {{ monsterService.subjectPronoun() }} instead take{{
            monsterService.verbPlural()
        }}
        no damage if {{ monsterService.subjectPronoun() }} succees on the saving throw, and only
        half damage if {{ monsterService.subjectPronoun() }} fail{{ monsterService.verbPlural() }}.
    </p>
    <p>
        <b><i>Flyby.</i></b
        >The {{ monsterService.name() }} doesn't provoke an Opportunity Attack when
        {{ monsterService.subjectPronoun() }}
        {{ monsterService.verbPlural() === 's' ? 'flies' : 'fly' }} out of an enemy's reach.
    </p>
    <p>
        <b><i>Magic Resistance.</i></b> The {{ monsterService.name() }} has advantage on saving
        throws against spells and other magical effects.
    </p>
    <p>
        <b><i>Legendary Resistance (3/Day).</i></b> If the {{ monsterService.name() }} fails a
        saving throw, {{ monsterService.subjectPronoun() }} can choose to succeed instead.
    </p>
    <p>
        <b><i>Sneak Attack.</i></b> Once per turn, {{ monsterService.name() }} deals an extra 17
        (5d6) damage when {{ monsterService.subjectPronoun() }} hit{{
            monsterService.verbPlural()
        }}
        a target with a weapon attack and
        {{ monsterService.verbPlural() === 's' ? 'has' : 'have' }} advantage on the attack roll, or
        when the target is within 5 feet of an ally if {{ monsterService.name() }} that isn't
        incapacitated and {{ monsterService.name() }} doesn't have disadvantage on the attack roll.
    </p>
    <p>
        <b><i>Assassinate.</i></b> During {{ monsterService.posessivePronoun() }} first turn,
        {{ monsterService.name() }} has advantage on attack rolls against any creature that hasn't
        taken a turn. Any hit {{ monsterService.name() }} scores against a surprised creature is a
        critical hit.
    </p>
    <p>
        <b><i>Unholy Aura.</i></b> All creatures within 10 feet of the
        {{ monsterService.name() }} have disadvantage on Constitution saving throws. Every creature
        within the unholy aura at the start of the {{ monsterService.name() }}'s turn loses 2d6 hit
        points, gains a level of Starvation, and the {{ monsterService.name() }}
        gains that many hit points.
    </p>
    <p>
        <b><i>Cunning Action.</i></b> On each of her turns, {{ monsterService.name() }} can use a
        bonus action to take the [action]Dash[/action], [action]Disengage[/action], or
        [action]Hide[/action] action.
    </p>
    <p>
        <b><i>Heightened Spell (3/Day).</i></b> As a bonus action, a target within 60 feet of
        {{ monsterService.name() }} has disadvantage on the their next saving throw against
        {{ monsterService.name() }}'s spell.
    </p>
</div>
